<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.3.4">Jekyll</generator><link href="https://pedrotaucce.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://pedrotaucce.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2024-10-10T02:03:14+00:00</updated><id>https://pedrotaucce.github.io/feed.xml</id><subtitle>Website of the Laboratório de Biologia Evolutiva e Sistemática de Tetrápodes Atuais (Laboratory of Evolutionary Biology and Systematics of Current Tetrapoda) at São Paulo State University. </subtitle><entry><title type="html">Building a calibrated gene tree with BEAST 2.7</title><link href="https://pedrotaucce.github.io/blog/2024/calibrated_gene_tree/" rel="alternate" type="text/html" title="Building a calibrated gene tree with BEAST 2.7"/><published>2024-10-06T11:00:00+00:00</published><updated>2024-10-06T11:00:00+00:00</updated><id>https://pedrotaucce.github.io/blog/2024/calibrated_gene_tree</id><content type="html" xml:base="https://pedrotaucce.github.io/blog/2024/calibrated_gene_tree/"><![CDATA[<p>Since our blog is called <strong>The BEAST</strong>, it is only fair that we debut our posts by discussing <strong>Bayesian Evolutionary Analysis Sampling Trees</strong>, or simply <a href="https://www.beast2.org">BEAST</a> (<a href="https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1006650">Bouckaert et al. 2019)</a>, one of the most widespread molecular phylogenetic software packages. Although there are many great <a href="https://www.beast2.org/tutorials/">tutorials</a> on the BEAST2 website and even an entire site dedicated to a yearly course taught by some of the developers (see <a href="https://taming-the-beast.org/tutorials/">Taming the BEAST</a>), I believe that a step-by-step guide aimed at new users is always welcome.</p> <p>In Bayesian phylogenetic analyses, hypotheses (<em>i.e.</em>, the tree and its parameters) are generated based on a data matrix, an assumed model of nucleotide evolution, and various priors. We will revisit all of this shortly, but for now, we will need a <a href="/assets/files/p_rupicola.fasta">molecular matrix</a>. For this, we will use the 16S mtDNA matrix from the description of <em>Pristimantis rupicola</em> (Anura: Brachycephaloidea), from <a href="https://bioone.org/journals/journal-of-herpetology/volume-54/issue-2/19-114/A-New-Rupicolous-Species-of-the-Pristimantis-conspicillatus-Group-Anura/10.1670/19-114.short">Taucce et al. (2020)</a>. I will assume you are familiar with retrieving sequences from <a href="https://www.ncbi.nlm.nih.gov/genbank/">GenBank</a> and aligning them, but we will cover these topics in future posts.</p> <p><strong>BEAST2</strong> interprets XML files, and to build one, we will use the <strong>BEAUti</strong> app, which is part of BEAST software package. First, we will load our molecular matrix by going to <code>File &gt; Import Alignment</code>. BEAUti will prompt us to specify the type of data we have, and we will select “nucleotide” (<a href="#fig1">Fig. 1</a>).</p> <div class="image-container mt-3"> <figure id="fig1"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig1.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 1:</strong> BEAUti screen after you have loaded the molecular matrix.</figcaption> </figure> </div> <p>We will leave the “Tip Dates” panel as it is and move on to the “Site Model” panel (<a href="#fig2">Fig. 2</a>). At this stage, we need to select a nucleotide substitution model for our data. While there are several software packages available for this task, BEAST conveniently includes an inbuilt package that will infer the best-fitting nucleotide substitution model simultaneously with the phylogenetic tree inference: <strong>bModelTest</strong> (<a href="https://bmcecolevol.biomedcentral.com/articles/10.1186/s12862-017-0890-6">Bouckaert &amp; Drummond, 2017</a>). If the <code>BEAST Model Test</code> option is not available, you may need to install it by navigating to <code>File &gt; Manage Packages</code>. With that in place, we are now ready to proceed to the next panel, “Clock Model.”</p> <div class="image-container mt-3" style="max-width: 50%; margin: 0 auto;"> <figure id="fig2"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig2.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 2:</strong> Site Model tab showing the use of the bModelTest package.</figcaption> </figure> </div> <p>When we open the panel, the strict clock model is already selected. This model assumes that the clock rate evolves equally across the entire tree. However, since our matrix involves interspecific relationships, this assumption is likely not suitable. We could test how “clock-like” our data are, but that will be the subject of a future post. For now, it is advisable to choose the “optimised relaxed clock model”.</p> <p>There are two main ways to date a phylogenetic tree: either by assigning ages to the nodes, usually based on geological events or fossil records, or by specifying a clock rate—<em>i.e.</em>, informing BEAST of the nucleotide substitution rate in our matrix. While it is common practice to use a single predetermined clock rate from the literature, we will take a different, more elegant approach. Since it is unlikely that the same clock rate applies to different datasets, estimating the rate is more appropriate. However, to ensure plausible results and aid the analysis in converging, it is recommended to introduce a narrow prior. But how do we do that?</p> <p>According to <a href="https://doi.org/10.1017/CBO9781139095112">Drummond &amp; Bouckaert (2015)</a>, if “a number of independent rate estimates from other papers on relevant taxa and gene regions” are available, one can fit a log-normal distribution to these values and use them as a prior. Since several estimates for the 16S gene in frogs are available in the literature (see <a href="https://doi.org/10.1111/j.1558-5646.2007.00181.x">Lemmon et al., 2007</a>, <a href="https://doi.org/10.1093/sysbio/syr130">Fouquet et al., 2012</a>, <a href="https://doi.org/10.1016/j.ympev.2017.04.007">Gehara et al., 2017</a>, and <a href="https://doi.org/10.1080/14772000.2022.2102686">Dufresnes et al., 2022</a>), we will follow this approach. All we need is <a href="https://www.R-project.org/">R</a> (R Core Team, 2024) and a small piece of code:</p> <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">fitdistrplus</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span><span class="w">

</span><span class="n">rate</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0.006</span><span class="p">,</span><span class="w"> </span><span class="m">0.00555</span><span class="p">,</span><span class="w"> </span><span class="m">0.00277</span><span class="p">,</span><span class="w"> </span><span class="m">0.005</span><span class="p">)</span><span class="w">  </span><span class="c1"># Define a vector of rates</span><span class="w">
</span><span class="n">ratedist</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">fitdist</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span><span class="w"> </span><span class="s2">"lnorm"</span><span class="p">)</span><span class="w">  </span><span class="c1"># Fit a log-normal distribution to the rate data</span><span class="w">

</span><span class="n">mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span><span class="w">  </span><span class="c1"># Calculate the mean of the rates, it will be useful as a starting point</span><span class="w">
</span><span class="n">log.mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unname</span><span class="p">(</span><span class="n">ratedist</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="s2">"meanlog"</span><span class="p">])</span><span class="w">  </span><span class="c1"># Get the estimated mean value from the fitted lognormal distribution</span><span class="w">
</span><span class="n">log.sd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unname</span><span class="p">(</span><span class="n">ratedist</span><span class="o">$</span><span class="n">estimate</span><span class="p">[</span><span class="s2">"sdlog"</span><span class="p">])</span><span class="w">  </span><span class="c1"># Get the estimated sd value from the fitted lognormal distribution</span><span class="w">
</span></code></pre></div></div> <p>In our case, the mean of the log-normal distribution is -5.374295 and the sd is 0.304072. We will use hese values in the “Priors” panel shortly. For now, let’s use the mean of our four rate values, 0.00483, as a starting point to help the Markov chains converge (<a href="#fig3">Fig. 3</a>). <strong>Do not forget to check the “estimate” box</strong>. To do this, navigate to <code>Mode</code> and uncheck the <code>Automatic set clock rate</code> option.</p> <div class="image-container mt-3" style="max-width: 50%; margin: 0 auto;"> <figure id="fig3"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig3.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig3.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 3:</strong> Clock Model panel showing the chosen model, Optimised Relaxed Clock, and the starting value of the <code>clock.rate</code> prior.</figcaption> </figure> </div> <p>Moving on to the “Priors” panel, we will see several parameters. We will leave most of them under default, but we will change the tree and the molecular clock priors. The current tree prior, “Yule”, has only one parameter to be estimated, the birth rate, assuming no extinction events. A more appropriate prior would be the Birth Death Model (<a href="#fig4">Fig. 4</a>), which does account for extinction.</p> <div class="image-container mt-3"> <figure id="fig4"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig4.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig4.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 4:</strong> Priors panel, showing the changes in tree and ORCucldMean models.</figcaption> </figure> </div> <p>Finally, we are going now to use the mean and standard deviation we calculated from our log-normal model. Open the <code>ORCucldMean.c</code> prior and add the meanlog value (in our case, -5.374295) to the M parameter and sdlog (0.304072) to S (<a href="#fig4">Fig. 4</a>). To make sure, you can plot your log-normal model and compare it to the one in BEAUti (<a href="#fig5">Fig. 5</a>):</p> <div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w">  </span><span class="c1"># Create a sequence of values from 0 to 0.01 with 100 points</span><span class="w">
</span><span class="n">y</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dlnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">meanlog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.mean</span><span class="p">,</span><span class="w"> </span><span class="n">sdlog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.sd</span><span class="p">)</span><span class="w">  </span><span class="c1"># Calculate the density of the log-normal distribution for the x values</span><span class="w">

</span><span class="c1"># Set up the graphics device to save the plot as a PNG file</span><span class="w">
</span><span class="n">png</span><span class="p">(</span><span class="s2">"your_path.png"</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"mm"</span><span class="p">,</span><span class="w">
    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">300</span><span class="p">,</span><span class="w"> </span><span class="n">pointsize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">)</span><span class="w">

</span><span class="c1"># Plot the density curve of the log-normal distribution</span><span class="w">
</span><span class="n">curve</span><span class="p">(</span><span class="n">dlnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">meanlog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.mean</span><span class="p">,</span><span class="w"> </span><span class="n">sdlog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log.sd</span><span class="p">),</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Probability density"</span><span class="p">,</span><span class="w">
      </span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.001</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.01</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"red"</span><span class="p">,</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Clock rate"</span><span class="p">,</span><span class="w"> </span><span class="n">lwd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">

</span><span class="c1"># Add a filled polygon under the density curve</span><span class="w">
</span><span class="n">polygon</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">rev</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="nf">rep</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">y</span><span class="p">))),</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rgb</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.5</span><span class="p">),</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">

</span><span class="n">dev.off</span><span class="p">()</span><span class="w">  </span><span class="c1"># Close the graphics device</span><span class="w">
</span></code></pre></div></div> <div class="image-container mt-3" style="max-width: 50%; margin: 0 auto;"> <figure id="fig5"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig5.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig5.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 5:</strong> Plot of the fitted log-normal model</figcaption> </figure> </div> <p>We will leave the MCMC panel unchanged. If your dataset is larger, you may want to consider increasing the number of generations, but for our matrix, 10 million generations with sampling every 1,000 generations should be sufficient.</p> <h3>Results</h3> <p>We will use <a href="https://github.com/beast-dev/tracer/releases/latest">Tracer</a> (<a href="https://academic.oup.com/sysbio/article/67/5/901/4989127">Rambaut et al., 2018</a>) to assess the convergence of the MCMC output. Ideally, all ESS values should exceed 200. When conducting the final analysis, you should run at least one additional replicate, starting from a different seed, to ensure that the MCMC has fully converged.</p> <p>To check our analysis, click the “+” button in the top left corner and load the <code>.log</code> file generated by BEAST. As shown in <a href="#fig6">Fig. 6</a>, a chain length of 10,000,000 generations was sufficient for the MCMC output to converge.</p> <div class="image-container mt-3"> <figure id="fig6"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig6.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig6.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 6:</strong> Tracer output after loading the log file.</figcaption> </figure> </div> <p>The <code>.trees</code> files generated by BEAST contain multiple trees, representing the posterior distribution from the Bayesian analysis. We will now summarize these into a Maximum Credibility Tree using another BEAST tool, <a href="https://beast2.blogs.auckland.ac.nz/treeannotator/">TreeAnnotator</a>. The only change I will make is regarding node heights, which I will set to “mean heights”—but feel free to use the option that best suits your analysis (<a href="#fig7">Fig. 7</a>).</p> <div class="image-container mt-3" style="max-width: 50%; margin: 0 auto;"> <figure id="fig7"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig7.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig7.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 7:</strong> TreeAnnotator window with node heights set to "mean heights".</figcaption> </figure> </div> <p>After adjusting the input to your <code>.trees</code> file and naming the output as you prefer, you can view the results using your favorite tree viewer. I hope your output looks as cool as mine (<a href="#fig8">Fig. 8</a>)!</p> <div class="image-container mt-3"> <figure id="fig8"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/posts/2024-10-06/fig8.png" sizes="95vw"/> <img src="/assets/img/posts/2024-10-06/fig8.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> <figcaption style="font-size: 0.9em; text-align: center;"><strong>Figure 8:</strong> Chronogram of 16S showing the relationships within *Pristimantis* species.</figcaption> </figure> </div> <h3>References</h3> <p>Bouckaert, R., &amp; Drummond, A. J. (2017). bModelTest: Bayesian phylogenetic site model averaging and model comparison. <em>BMC Evolutionary Biology</em>, <strong>17</strong>(1), 42.</p> <p>Bouckaert, R., Vaughan, T. G., Barido-Sottani, J., Duchêne, S., Fourment, M., Gavryushkina, A., et al. (2019). BEAST 2.5: An advanced software platform for Bayesian evolutionary analysis. <em>PLoS Computational Biology</em>, <strong>15</strong>(4), e1006650.</p> <p>Dufresnes, C., Mahony, S., Prasad, V. K., Kamei, R. G., Masroor, R., Khan, M. A., … Litvinchuk, S. N. (2022). Shedding light on taxonomic chaos: Diversity and distribution of South Asian skipper frogs (Anura, Dicroglossidae, Euphlyctis). <em>Systematics and Biodiversity</em>, <strong>20</strong>(1), 1–25.</p> <p>Fouquet, A., Noonan, B. P., Rodrigues, M. T., Pech, N., Gilles, A., &amp; Gemmell, N. J. (2012). Multiple Quaternary refugia in the eastern Guiana Shield revealed by comparative phylogeography of 12 frog species. <em>Systematic Biology</em>, <strong>61</strong>(3), 461.</p> <p>Gehara, M., Barth, A., de Oliveira, E. F., Costa, M. A., Haddad, C. F. B., &amp; Vences, M. (2017). Model-based analyses reveal insular population diversification and cryptic frog species in the <em>Ischnocnema parva</em> complex in the Atlantic forest of Brazil. <em>Molecular Phylogenetics and Evolution</em>, <strong>112</strong>, 68–78.</p> <p>Lemmon, E. M., Lemmon, A. R., &amp; Cannatella, D. C. (2007). Geological and climatic forces driving speciation in the continentally distributed trilling chorus frogs (<em>Pseudacris</em>). <em>Evolution</em>, <strong>61</strong>, 2086–2103.</p> <p>R Core Team (2024). R: A language and environment for statistical computing. <em>R Foundation for Statistical Computing</em>, Vienna, Austria.</p> <p>Taucce, P. P. G., Nascimento, J. S., Trevisan, C. C., Leite, F. S. F., Santana, D. J., Haddad, C. F. B., &amp; Napoli, M. F. (2020). A new rupicolous species of the <em>Pristimantis conspicillatus</em> group (Anura: Brachycephaloidea: Craugastoridae) from Central Bahia, Brazil. <em>Journal of Herpetology</em>, <strong>54</strong>(2), 245–257.</p>]]></content><author><name></name></author><category term="Phylogenetics"/><category term="BEAST"/><category term="Dating"/><category term="UltrametricTree"/><category term="MolecularClock"/><summary type="html"><![CDATA[A step-by-step beginner's guide]]></summary></entry></feed>